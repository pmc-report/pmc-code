<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gean.pmc_report_manager.modules.report.dao.TaBiw3OprDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="gean.pmc_report_manager.modules.report.entity.TaBiw3OprEntity" id="taBiw3OprMap">
       <result property="shop" column="shop" />
		<result property="line" column="line" />
		<result property="zone" column="zone" />
		<result property="station" column="station" />
		<result property="equipment" column="equipment" />
		<result property="facilityId" column="facility_id" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="availableTime" column="available_time" />
		<result property="productionVolume" column="production_volume" />
		<result property="frequency" column="frequency" />
		<result property="workingday" column="workingDay" />
		<result property="levels" column="levels" />
		<result property="shift" column="shift" />
		<result property="tarOpr" column="tar_opr" />
		<result property="designCycleTime" column="design_cycle_time" />
		<result property="productionOpr" column="production_opr" />
    </resultMap>
    
    <sql id="Base_column_Opr">
    	shop,line,zone,station,equipment,facility_id,start_time,end_time,available_time,
    	production_volume,frequency,workingday,levels,shift,tar_opr,design_cycle_time,production_opr
    </sql>
    
    <resultMap type="gean.pmc_report_manager.modules.report.vo.OprReportVo" id="oprReportMap">
    	<result property="oprTarget" column="tar_opr"/>
    	<result property="eOpr" column="e_opr"/>
    	<result property="productionVolume" column="production_volume"/>
    	<result property="availableTime" column="available_time"/>
    	<result property="popr" column="production_opr"/>
    	<result property="workingDay" column="workingDay"/>
    	<result property="role" column="frequency"/>
    </resultMap>
    
     <resultMap type="gean.pmc_report_manager.modules.report.vo.ZoneOprVo" id="zoneOprVoMap">
    	<result property="starved" column="starved"/>
    	<result property="zone" column="zone"/>
    	<result property="goodPartCount" column="goodPartCount"/>
    	<result property="downTime" column="downTime"/>
    	<result property="productionOpr" column="productionOpr"/>
    	<result property="equipmentOpr" column="equipmentOpr"/>
    	<result property="equipAvail" column="equipAvail"/>
		<result property="cycleTime" column="cycleTime"/>
		<result property="blocked" column="blocked"/>
		<result property="facilityId" column="facilityId"/>    	    	
    </resultMap>
	
	 <select id="queryStarvedAndblocked" resultMap="zoneOprVoMap">
		BEGIN WITH mainquery AS(
		select 
			zone, facility_id, state "States", duration
				from PMC.dbo.PMC_BIW_STATE 
			where 1 = 1 
				<if test="area!=null and area!=''">
					AND line = #{area}
				</if>
				<if test="zone!=null and zone!=''">
					and zone = #{zone}
				</if>
				<if test="facilityId!=null and facilityId!=''">
					and facility_id = #{facilityId}
				</if>
				<if test="workDay!=null">
					and CONVERT(VARCHAR(100),end_time,112) = CONVERT(VARCHAR(100),#{workDay},112)
				</if>
				<choose>
					<when test="shift!=null and shift!=''">
						AND shift = #{shift}
					</when>
					<otherwise>
						AND shift = 'D'
					</otherwise>
				</choose>
		)
		select x.zone "Zone", x.facility_id "FacilityID",
			ISNULL((select sum(y.duration) from mainquery y where x.facility_id = y.facility_id  and y.States ='Starved'),0)"starved",

			ISNULL((select sum(y.duration) from mainquery y where x.facility_id = y.facility_id and y.States ='Blocked'),0)"blocked",
			ISNULL((select sum(y.duration) from mainquery y where x.facility_id = y.facility_id and (y.States ='WaitingAttn' or y.States='RepairInProgress' or y.States='ShutDown' or y.States='Estop')),0)"Downtime"
		from(
			SELECT y.facility_id,y.zone FROM mainquery y
			group by y.facility_id,y.zone
		)x
		END  
	</select>
	
	<select id = "queryDownTime" resultType="Integer">
		select SUM(duration) as "downTime"
		from PMC.dbo.PMC_BIW_FAULT where 1 = 1
 		<if test="zone!=null and zone!=''">
 			and zone = #{zone}
 		</if>
   		<if test="facilityId!=null and facilityId!=''">
			and facility_id = #{facilityId}
		</if>
		<if test="workDay!=null">
			and CONVERT(DATE,end_time,112) = CONVERT(DATE,#{workDay},112)
		</if>
	</select>
	
	<select id="queryTechAvali" resultType="Float">
		select tech_avail as "equipAvail"
			from PMC.dbo.PMC_9PANEL_TA 
			where 1 = 1
			
	 		<if test="area!=null and area!=''">
				and line = #{area}
			</if>
			<if test="zone!=null and zone!=''">
				and zone = #{zone}
			</if>
		<choose>
			<when test="shift!=null and shift!=''">
				AND shift = #{shift}
			</when>
			<otherwise>
				AND shift = 'D'
			</otherwise>
		</choose>
		<choose>
			<when test="workDay!=null">
				AND CONVERT(VARCHAR(100),workingDay,112) = CONVERT(VARCHAR(100),#{workDay},112) 
			</when>	
			<otherwise>
				AND CONVERT(VARCHAR(100),workingDay,112) = CONVERT(VARCHAR(100),GETDATE(),112)
			</otherwise>
		</choose>
		AND levels = 'zone'
		AND frequency = '1'
	</select>
	
	<select id="queryGoodPartCount" resultType="Integer">
		select 
			max(good_cycle_count) "goodPartCount"
		from PMC.dbo.PMC_BIW_CYCLE
		where 1 = 1
		
		<if test="area!=null and area!=''">
			and area=#{area}
		</if>
		<if test="zone!=null and zone!=''">
			and zone = #{zone}
		</if>
		  <if test="facilityId!=null and facilityId!=''">
			and facility_id = #{facilityId}
		</if>
		<choose>
			<when test="workDay!=null">
				and CONVERT(DATE,end_time,112) = CONVERT(DATE,#{workDay},112)
			</when>
			<otherwise>
				and CONVERT(DATE,end_time,112) = CONVERT(DATE,GETDATE(),112)
			</otherwise>
		</choose>
		<choose>
			<when test="shift!=null and shift!=''">
				and shift = #{shift}
			</when>
			<otherwise>
				and shift = 'D'
			</otherwise>
		</choose>
	</select>
	
	<select id="queryAvailableTime" resultType="Float">
		select available_time
		from PMC.dbo.PMC_OPR 
		where 1 = 1
		<if test="workDay!=null">
			and CONVERT (VARCHAR(100),workingDay,112) = CONVERT(VARCHAR(100),#{workDay},112)
		</if>
		<if test="area!=null and area!=''">
			and line = #{area}
		</if>
		<if test="zone!=null and zone!=''">
			and zone = #{zone}
		</if>
		<if test="shift!=null and shift!=''">
			and shift = #{shift}
		</if>
		and levels='zone'
		and frequency='Daily';
	</select>
</mapper>